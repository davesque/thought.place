#!/usr/bin/env bash

set -o errexit
set -o pipefail

indent() {
  RE="s/^/       /"
  [ $(uname) == "Darwin" ] && sed -l "$RE" || sed -u "$RE"
}

MANAGE_FILE=$(find . -maxdepth 3 -type f -name 'manage.py' | head -1)
MANAGE_FILE=${MANAGE_FILE:2}

echo "-----> Compressing static files"
python $MANAGE_FILE compress 2>&1 | indent

PDFLATEX_FILE=$(find . -name 'pdflatex' | head -1)
PDFLATEX_DIR=$(dirname "${PDFLATEX_FILE:2}")

PANDOC_FILE=$(find . -type f -name 'pandoc' | head -1)
PANDOC_DIR=$(dirname "${PANDOC_FILE:2}")

PDF2SVG_FILE=$(find . -type f -name 'pdf2svg' | head -1)
PDF2SVG_DIR=$(dirname "${PDF2SVG_FILE:2}")

echo "---"
echo "$PDFLATEX_FILE"
echo "$PDFLATEX_DIR"
echo "---"
echo "$PANDOC_FILE"
echo "$PANDOC_DIR"
echo "---"
echo "$PDF2SVG_FILE"
echo "$PDF2SVG_DIR"
echo "---"

echo "-----> Loading articles"
PATH="$PANDOC_DIR:$PDF2SVG_DIR:$PATH" python $MANAGE_FILE loadarticles 2>&1 | indent

echo
